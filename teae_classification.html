<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive TEAE Classifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple transition for modal visibility */
        .modal {
            display: none;
            transition: opacity 0.3s ease;
        }
        .modal.active {
            display: flex;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 sm:p-6 lg:p-8">

    <div class="max-w-screen-2xl mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">TEAE Timeline Visualizer</h1>
            <p class="text-gray-600 mt-1">An interactive tool to classify Treatment-Emergent Adverse Events (Treatment starts Day 1).</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Column: Timeline -->
            <div class="lg:w-2/3">
                <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-wrap gap-4 justify-between items-center">
                    <div class="flex items-center space-x-2 flex-wrap gap-2">
                        <button id="add-ae-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">Add AE</button>
                        <button id="pseudo-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">Generate Pseudocode</button>
                        <button id="export-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Export XML</button>
                        <button id="import-btn" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700">Import XML</button>
                        <input type="file" id="import-file-input" class="hidden" accept=".xml">
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                    <div id="timeline-wrapper" class="relative">
                        <!-- Timeline will be rendered here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Reasoning Pane -->
            <div class="lg:w-1/3">
                <div id="reasoning-pane">
                    <!-- Reasoning Pane will be rendered here by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modal-container">
        <!-- Modals will be injected here by JavaScript -->
    </div>


    <script>
        // --- GLOBAL STATE & CONSTANTS ---
        const SEVERITY_LEVELS = { None: 0, Mild: 1, Moderate: 2, Severe: 3 };
        const SEVERITY_COLORS = { Mild: 'bg-green-500', Moderate: 'bg-yellow-500', Severe: 'bg-red-500' };

        let state = {
            treatmentPeriod: { startDate: '2024-01-15', endDate: '2024-02-15' },
            adverseEvents: [
                { id: 'ae_1', name: 'Nausea', segments: [{ startDate: '2024-01-16', endDate: '2024-01-20', severity: 'Mild' }], overrideTEAE: null },
                { id: 'ae_2', name: 'Headache', segments: [{ startDate: '2024-01-10', endDate: '2024-01-18', severity: 'Moderate' }], overrideTEAE: null },
                { id: 'ae_3', name: 'Fatigue', segments: [{ startDate: '2024-01-05', endDate: '2024-01-12', severity: 'Mild' }], overrideTEAE: null },
                { id: 'ae_4', name: 'Dizziness', segments: [{ startDate: '2024-01-12', endDate: '2024-01-16', severity: 'Mild' }, { startDate: '2024-01-17', endDate: '2024-01-22', severity: 'Severe' }], overrideTEAE: null },
            ],
            selectedAEId: 'ae_2',
            timelineStartStudyDay: -15,
            timelineDays: 45,
        };
        state.treatmentStartDate = new Date(state.treatmentPeriod.startDate);


        // --- HELPER FUNCTIONS ---
        const formatDate = (date) => date.toISOString().split('T')[0];
        const addDays = (date, days) => {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        };
        const getDayDiff = (startDate, endDate) => {
            const msPerDay = 1000 * 60 * 60 * 24;
            const start = new Date(startDate);
            start.setHours(12, 0, 0, 0);
            const end = new Date(endDate);
            end.setHours(12, 0, 0, 0);
            return Math.round((end - start) / msPerDay);
        };
        const dateToStudyDay = (date, treatmentStart) => {
            const diff = getDayDiff(treatmentStart, new Date(date));
            return diff < 0 ? diff : diff + 1;
        };
        const studyDayToDate = (day, treatmentStart) => {
            const offset = day < 1 ? day : day - 1;
            return formatDate(addDays(treatmentStart, offset));
        };

        // --- CORE LOGIC ---
        const getTEAEClassification = (ae, treatmentStartDate) => {
            if (!ae || !treatmentStartDate) return { isTEAE: false, reason: "Invalid data." };
            const treatmentStartDateTime = new Date(treatmentStartDate).getTime();
            const sortedSegments = [...ae.segments].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            let preTreatmentSeverity = SEVERITY_LEVELS.None;
            let preTreatmentSeverityName = "None";
            for (const segment of sortedSegments) {
                const segmentStartDateTime = new Date(segment.startDate).getTime();
                const segmentEndDateTime = new Date(segment.endDate).getTime();
                if (segmentEndDateTime < treatmentStartDateTime) {
                    preTreatmentSeverity = SEVERITY_LEVELS[segment.severity];
                    preTreatmentSeverityName = segment.severity;
                } else if (segmentStartDateTime < treatmentStartDateTime && segmentEndDateTime >= treatmentStartDateTime) {
                    preTreatmentSeverity = SEVERITY_LEVELS[segment.severity];
                    preTreatmentSeverityName = segment.severity;
                    break;
                }
            }
            const lastEventSegment = sortedSegments[sortedSegments.length - 1];
            if (new Date(lastEventSegment.endDate).getTime() < treatmentStartDateTime) {
                return { isTEAE: false, reason: "Not TEAE because the event resolved entirely before the treatment period started on Day 1." };
            }
            for (const segment of sortedSegments) {
                const segmentStartDateTime = new Date(segment.startDate).getTime();
                const segmentSeverity = SEVERITY_LEVELS[segment.severity];
                if (segmentStartDateTime >= treatmentStartDateTime) {
                    if (segmentSeverity > preTreatmentSeverity) {
                        return { isTEAE: true, reason: preTreatmentSeverity === SEVERITY_LEVELS.None ? `TEAE because it is a new event (Severity: ${segment.severity}) that started on or after Day 1.` : `TEAE because it worsened from a pre-treatment severity of '${preTreatmentSeverityName}' to '${segment.severity}' on or after Day 1.` };
                    }
                }
            }
            return { isTEAE: false, reason: `Not TEAE because the event was pre-existing and its severity ('${lastEventSegment.severity}') did not worsen compared to the pre-treatment severity ('${preTreatmentSeverityName}').` };
        };

        // --- DOM MANIPULATION & RENDERING ---
        
        function renderReasoningPane() {
            const container = document.getElementById('reasoning-pane');
            const ae = state.adverseEvents.find(e => e.id === state.selectedAEId);
            
            if (!ae) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md h-full">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Classification Details</h3>
                        <div class="text-center text-gray-500 mt-8">
                            <p class="mt-4">Click on an Adverse Event in the timeline to see its classification details here.</p>
                        </div>
                    </div>`;
                return;
            }

            const { isTEAE, reason } = getTEAEClassification(ae, state.treatmentStartDate);
            const finalIsTEAE = ae.overrideTEAE ?? isTEAE;
            
            container.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md h-full">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Classification Details</h3>
                    <h4 class="text-lg font-semibold text-indigo-600 mb-4">${ae.name}</h4>
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Status</p>
                            <p class="text-lg font-bold ${finalIsTEAE ? 'text-red-600' : 'text-gray-800'}">
                                ${finalIsTEAE ? 'Treatment-Emergent (TEAE)' : 'Not Treatment-Emergent'}
                            </p>
                            ${ae.overrideTEAE !== null ? '<p class="text-sm text-blue-600 italic">Manually Overridden</p>' : ''}
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Reasoning</p>
                            <p class="text-gray-700 bg-gray-50 p-3 rounded-md">
                                ${ae.overrideTEAE !== null ? `The classification was manually overridden. The system's original assessment was: "${reason}"` : reason}
                            </p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Actions</p>
                            <div class="flex flex-wrap gap-2 mt-1">
                                 <button data-action="override" data-id="${ae.id}" class="px-3 py-1 text-sm bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Override Status</button>
                                 <button data-action="split" data-id="${ae.id}" class="px-3 py-1 text-sm bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" ${ae.segments.length > 1 ? 'disabled' : ''}>Split Event</button>
                                 <button data-action="recurrence" data-id="${ae.id}" class="px-3 py-1 text-sm bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Add Recurrence</button>
                                 <button data-action="delete" data-id="${ae.id}" class="px-3 py-1 text-sm bg-red-200 text-red-800 rounded-md hover:bg-red-300">Delete AE</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function renderTimeline() {
            const wrapper = document.getElementById('timeline-wrapper');
            const studyDaysArray = [];
            for (let i = 0; i < state.timelineDays; i++) {
                const day = state.timelineStartStudyDay + i;
                if (day !== 0) studyDaysArray.push(day);
            }
            const dayToIndex = (day) => studyDaysArray.indexOf(day);

            let dayHeadersHTML = '';
            studyDaysArray.forEach(day => {
                dayHeadersHTML += `
                    <div class="flex-shrink-0 text-center border-r border-gray-200 py-1 ${day === 1 ? 'bg-blue-100' : ''}" style="width: 60px;">
                        <div class="text-xs text-gray-500">Day</div>
                        <div class="text-lg font-semibold text-gray-800">${day}</div>
                    </div>`;
            });

            let aeRowsHTML = '';
            state.adverseEvents.forEach(ae => {
                const { isTEAE } = getTEAEClassification(ae, state.treatmentStartDate);
                const finalIsTEAE = ae.overrideTEAE ?? isTEAE;
                let segmentsHTML = '';
                ae.segments.forEach(segment => {
                    const startDay = dateToStudyDay(segment.startDate, state.treatmentStartDate);
                    const endDay = dateToStudyDay(segment.endDate, state.treatmentStartDate);
                    const left = dayToIndex(startDay) * 60;
                    const width = (dayToIndex(endDay) - dayToIndex(startDay) + 1) * 60;
                    segmentsHTML += `
                        <div class="absolute h-8 top-4 rounded-md shadow-sm flex items-center justify-center px-2 ${SEVERITY_COLORS[segment.severity]}" style="left: ${left}px; width: ${width}px;">
                            <span class="text-white text-xs font-bold truncate">${ae.name}</span>
                        </div>`;
                });

                aeRowsHTML += `
                    <div data-id="${ae.id}" class="ae-row h-16 flex items-center relative cursor-pointer rounded-lg transition-colors duration-200 ${state.selectedAEId === ae.id ? 'bg-indigo-50' : 'hover:bg-gray-50'}">
                        <div class="absolute flex h-full" style="left: 0; right: 0;">${segmentsHTML}</div>
                        <div class="absolute -left-44 w-40 text-right pr-2 text-sm font-medium ${finalIsTEAE ? 'text-red-600' : 'text-gray-700'}">
                            ${ae.name}
                            <span class="block text-xs font-bold ${finalIsTEAE ? 'text-red-500' : 'text-gray-500'}">
                                ${finalIsTEAE ? 'TEAE' : 'Not TEAE'}
                            </span>
                        </div>
                    </div>`;
            });

            wrapper.style.width = `${studyDaysArray.length * 60}px`;
            wrapper.innerHTML = `
                <div class="flex border-b-2 border-gray-300">${dayHeadersHTML}</div>
                <div class="absolute h-full top-0 bg-blue-300 bg-opacity-30 rounded-md pointer-events-none" style="left: ${dayToIndex(1) * 60}px; width: ${(getDayDiff(new Date(state.treatmentPeriod.startDate), new Date(state.treatmentPeriod.endDate)) + 1) * 60}px; top: 52px;"></div>
                <div class="mt-2 space-y-2">${aeRowsHTML}</div>
            `;
        }

        function showModal(content) {
            const container = document.getElementById('modal-container');
            container.innerHTML = content;
            const modal = container.querySelector('.modal');
            if (modal) {
                setTimeout(() => modal.classList.add('active'), 10);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) hideModals();
                });
            }
        }

        function hideModals() {
            const modal = document.querySelector('.modal.active');
            if(modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    document.getElementById('modal-container').innerHTML = '';
                }, 300);
            }
        }

        function renderAll() {
            renderTimeline();
            renderReasoningPane();
            addEventListeners();
        }
        
        // --- EVENT HANDLING ---
        function handleTimelineClick(e) {
            const aeRow = e.target.closest('.ae-row');
            if (aeRow) {
                state.selectedAEId = aeRow.dataset.id;
                renderAll();
            }
        }

        function handleReasoningPaneClick(e) {
            const button = e.target.closest('button');
            if (!button) return;
            const { action, id } = button.dataset;
            const ae = state.adverseEvents.find(e => e.id === id);

            if (action === 'override') {
                const { isTEAE } = getTEAEClassification(ae, state.treatmentStartDate);
                const currentStatus = ae.overrideTEAE ?? isTEAE;
                ae.overrideTEAE = !currentStatus;
                renderAll();
            }
            if (action === 'split') {
                if (ae && ae.segments.length === 1) {
                    showSplitModal(ae);
                }
            }
            if (action === 'recurrence') {
                showRecurrenceModal(ae);
            }
            if (action === 'delete') {
                showDeleteConfirmModal(ae);
            }
        }
        
        function showAddAEModal() {
            const modalHTML = `
                <div class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl p-6 md:p-8 w-11/12 md:w-1/2 lg:w-1/3 relative">
                        <button onclick="hideModals()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                        <form id="add-ae-form" class="space-y-4">
                            <h2 class="text-2xl font-bold text-gray-800">Add Adverse Event</h2>
                            <div id="form-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"></div>
                            <div>
                                <label for="ae-name" class="block text-sm font-medium text-gray-700">AE Name</label>
                                <input id="ae-name" name="name" type="text" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="e.g., Headache" />
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="start-day" class="block text-sm font-medium text-gray-700">Start Day</label>
                                    <input id="start-day" name="startDay" type="number" value="1" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" />
                                </div>
                                <div>
                                    <label for="end-day" class="block text-sm font-medium text-gray-700">End Day</label>
                                    <input id="end-day" name="endDay" type="number" value="2" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" />
                                </div>
                            </div>
                            <div>
                                <label for="severity" class="block text-sm font-medium text-gray-700">Severity</label>
                                <select id="severity" name="severity" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                                    ${Object.keys(SEVERITY_LEVELS).filter(s => s !== 'None').map(level => `<option value="${level}">${level}</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex justify-end space-x-3 pt-2">
                                <button type="button" onclick="hideModals()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            showModal(modalHTML);
            document.getElementById('add-ae-form').addEventListener('submit', handleSaveAE);
        }

        function handleSaveAE(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const name = formData.get('name').trim();
            const startDay = parseInt(formData.get('startDay'), 10);
            const endDay = parseInt(formData.get('endDay'), 10);
            const errorDiv = document.getElementById('form-error');

            if (!name) {
                errorDiv.textContent = 'AE Name is required.';
                errorDiv.classList.remove('hidden');
                return;
            }
            if (endDay < startDay) {
                errorDiv.textContent = 'End day cannot be before start day.';
                errorDiv.classList.remove('hidden');
                return;
            }

            const newAE = {
                id: `ae_${Date.now()}`,
                name,
                segments: [{
                    startDate: studyDayToDate(startDay, state.treatmentStartDate),
                    endDate: studyDayToDate(endDay, state.treatmentStartDate),
                    severity: formData.get('severity')
                }],
                overrideTEAE: null,
            };
            state.adverseEvents.push(newAE);
            state.selectedAEId = newAE.id;
            hideModals();
            renderAll();
        }
        
        function showSplitModal(ae) {
            const segment = ae.segments[0];
            const startDay = dateToStudyDay(segment.startDate, state.treatmentStartDate);
            const endDay = dateToStudyDay(segment.endDate, state.treatmentStartDate);

            const modalHTML = `
                <div class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl p-6 md:p-8 w-11/12 md:w-1/2 lg:w-1/3 relative">
                        <button onclick="hideModals()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                        <form id="split-ae-form" class="space-y-4" data-id="${ae.id}">
                            <h2 class="text-2xl font-bold text-gray-800">Split Adverse Event</h2>
                            <p class="text-sm text-gray-600">Splitting "${ae.name}" from Day ${startDay} to Day ${endDay}.</p>
                            <div id="form-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"></div>
                            <div>
                                <label for="split-day" class="block text-sm font-medium text-gray-700">Split On (Start of Day)</label>
                                <input id="split-day" name="splitDay" type="number" value="${startDay + 1}" min="${startDay + 1}" max="${endDay}" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" />
                            </div>
                            <div>
                                <label for="new-severity" class="block text-sm font-medium text-gray-700">Severity for New Segment</label>
                                <select id="new-severity" name="newSeverity" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                                     ${Object.keys(SEVERITY_LEVELS).filter(s => s !== 'None').map(level => `<option value="${level}" ${level === segment.severity ? 'selected' : ''}>${level}</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex justify-end space-x-3 pt-2">
                                <button type="button" onclick="hideModals()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Split</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            showModal(modalHTML);
            document.getElementById('split-ae-form').addEventListener('submit', handleSplitSave);
        }

        function handleSplitSave(e) {
            e.preventDefault();
            const form = e.target;
            const aeId = form.dataset.id;
            const formData = new FormData(form);
            const splitDay = parseInt(formData.get('splitDay'), 10);
            const newSeverity = formData.get('newSeverity');
            
            const ae = state.adverseEvents.find(e => e.id === aeId);
            const originalSegment = ae.segments[0];
            const startDay = dateToStudyDay(originalSegment.startDate, state.treatmentStartDate);
            const endDay = dateToStudyDay(originalSegment.endDate, state.treatmentStartDate);
            const errorDiv = document.getElementById('form-error');

            if (splitDay <= startDay || splitDay > endDay) {
                errorDiv.textContent = 'Split day must be within the event\'s duration.';
                errorDiv.classList.remove('hidden');
                return;
            }

            const splitDate = studyDayToDate(splitDay, state.treatmentStartDate);
            const firstPart = { ...originalSegment, endDate: formatDate(addDays(new Date(splitDate), -1)) };
            const secondPart = { ...originalSegment, startDate: splitDate, severity: newSeverity };

            ae.segments = [firstPart, secondPart];
            hideModals();
            renderAll();
        }

        function showRecurrenceModal(ae) {
            const lastSegment = ae.segments[ae.segments.length - 1];
            const lastEndDay = dateToStudyDay(lastSegment.endDate, state.treatmentStartDate);

            const modalHTML = `
                <div class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl p-6 md:p-8 w-11/12 md:w-1/2 lg:w-1/3 relative">
                        <button onclick="hideModals()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                        <form id="recurrence-ae-form" class="space-y-4" data-id="${ae.id}">
                            <h2 class="text-2xl font-bold text-gray-800">Add Recurrence for "${ae.name}"</h2>
                            <div id="form-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="start-day" class="block text-sm font-medium text-gray-700">Start Day</label>
                                    <input id="start-day" name="startDay" type="number" value="${lastEndDay + 2}" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" />
                                </div>
                                <div>
                                    <label for="end-day" class="block text-sm font-medium text-gray-700">End Day</label>
                                    <input id="end-day" name="endDay" type="number" value="${lastEndDay + 3}" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" />
                                </div>
                            </div>
                            <div>
                                <label for="severity" class="block text-sm font-medium text-gray-700">Severity</label>
                                <select id="severity" name="severity" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                                    ${Object.keys(SEVERITY_LEVELS).filter(s => s !== 'None').map(level => `<option value="${level}">${level}</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex justify-end space-x-3 pt-2">
                                <button type="button" onclick="hideModals()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Recurrence</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            showModal(modalHTML);
            document.getElementById('recurrence-ae-form').addEventListener('submit', handleSaveRecurrence);
        }

        function handleSaveRecurrence(e) {
            e.preventDefault();
            const form = e.target;
            const aeId = form.dataset.id;
            const formData = new FormData(form);
            const startDay = parseInt(formData.get('startDay'), 10);
            const endDay = parseInt(formData.get('endDay'), 10);
            const errorDiv = document.getElementById('form-error');
            const ae = state.adverseEvents.find(e => e.id === aeId);
            const lastSegment = ae.segments[ae.segments.length - 1];
            const lastEndDay = dateToStudyDay(lastSegment.endDate, state.treatmentStartDate);

            if (endDay < startDay) {
                errorDiv.textContent = 'End day cannot be before start day.';
                errorDiv.classList.remove('hidden');
                return;
            }
             if (startDay <= lastEndDay + 1) {
                errorDiv.textContent = 'Recurrence must start at least 2 days after the previous occurrence ends.';
                errorDiv.classList.remove('hidden');
                return;
            }

            const newSegment = {
                startDate: studyDayToDate(startDay, state.treatmentStartDate),
                endDate: studyDayToDate(endDay, state.treatmentStartDate),
                severity: formData.get('severity')
            };

            ae.segments.push(newSegment);
            hideModals();
            renderAll();
        }
        
        function showDeleteConfirmModal(ae) {
            const modalHTML = `
                <div class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl p-6 md:p-8 w-11/12 md:w-auto">
                        <h2 class="text-xl font-bold text-gray-800">Confirm Deletion</h2>
                        <p class="text-gray-600 mt-2">Are you sure you want to delete the adverse event "${ae.name}"?</p>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="hideModals()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                            <button type="button" id="confirm-delete-btn" data-id="${ae.id}" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
                        </div>
                    </div>
                </div>`;
            showModal(modalHTML);
            document.getElementById('confirm-delete-btn').addEventListener('click', (e) => {
                const aeId = e.target.dataset.id;
                handleDeleteAE(aeId);
            });
        }

        function handleDeleteAE(aeId) {
            state.adverseEvents = state.adverseEvents.filter(ae => ae.id !== aeId);
            if (state.selectedAEId === aeId) {
                state.selectedAEId = null;
            }
            hideModals();
            renderAll();
        }


        function addEventListeners() {
            const timelineWrapper = document.getElementById('timeline-wrapper');
            timelineWrapper.removeEventListener('click', handleTimelineClick);
            timelineWrapper.addEventListener('click', handleTimelineClick);

            const reasoningPane = document.getElementById('reasoning-pane');
            reasoningPane.removeEventListener('click', handleReasoningPaneClick);
            reasoningPane.addEventListener('click', handleReasoningPaneClick);
            
            document.getElementById('add-ae-btn').addEventListener('click', showAddAEModal);
            
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
            document.getElementById('import-file-input').addEventListener('change', handleImportXML);
            document.getElementById('export-btn').addEventListener('click', handleExportXML);
        }

        // --- IMPORT / EXPORT ---
        function handleExportXML() {
            let xmlString = '<?xml version="1.0" encoding="UTF-8"?>\n<teaeData>\n';
            state.adverseEvents.forEach(ae => {
                xmlString += `  <adverseEvent id="${ae.id}" name="${ae.name}" overrideTEAE="${ae.overrideTEAE}">\n`;
                ae.segments.forEach(seg => {
                    xmlString += `    <segment startDate="${seg.startDate}" endDate="${seg.endDate}" severity="${seg.severity}" />\n`;
                });
                xmlString += `  </adverseEvent>\n`;
            });
            xmlString += '</teaeData>';

            const blob = new Blob([xmlString], { type: 'application/xml' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'teae-data.xml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function handleImportXML(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const xmlContent = e.target.result;
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlContent, "application/xml");
                    
                    // Error handling for malformed XML
                    const parseError = xmlDoc.querySelector("parsererror");
                    if (parseError) {
                        throw new Error("Failed to parse XML file. Please check the format.");
                    }
                    
                    const newAEs = [];
                    const aeNodes = xmlDoc.getElementsByTagName('adverseEvent');

                    for (const node of aeNodes) {
                        const segments = [];
                        const segmentNodes = node.getElementsByTagName('segment');
                        for (const segNode of segmentNodes) {
                            segments.push({
                                startDate: segNode.getAttribute('startDate'),
                                endDate: segNode.getAttribute('endDate'),
                                severity: segNode.getAttribute('severity'),
                            });
                        }

                        let override = node.getAttribute('overrideTEAE');
                        if (override === 'true') override = true;
                        else if (override === 'false') override = false;
                        else override = null;

                        newAEs.push({
                            id: node.getAttribute('id'),
                            name: node.getAttribute('name'),
                            overrideTEAE: override,
                            segments: segments,
                        });
                    }
                    state.adverseEvents = newAEs;
                    state.selectedAEId = newAEs.length > 0 ? newAEs[0].id : null;
                    renderAll();
                } catch (error) {
                    console.error("Import Error:", error);
                    alert("Could not import file. Please ensure it is a valid XML exported from this tool.");
                } finally {
                    // Reset file input to allow re-importing the same file
                    event.target.value = null;
                }
            };
            reader.readAsText(file);
        }


        document.getElementById('pseudo-btn').addEventListener('click', () => {
             const pseudocode = `// Pseudocode for TEAE Determination Logic

// This function determines if an Adverse Event is Treatment-Emergent.
// An AE is a collection of one or more periods where a patient experiences a condition.
// Each period is a "Continous AE".
FUNCTION isTreatmentEmergent(adverseEvent, treatmentStartDate):

  // 1. Determine the pre-treatment severity.
  //    This is the severity of the last Continous AE active BEFORE Day 1.
  preTreatmentSeverity = "None"
  FOR EACH ContinousAE IN adverseEvent.segments SORTED BY startDate:
    // Check any Continous AE that ends before treatment or spans the treatment start date
    IF ContinousAE.endDate < treatmentStartDate OR ContinousAE.startDate < treatmentStartDate:
      preTreatmentSeverity = ContinousAE.severity

  // 2. Check all Continous AEs for TEAE conditions.
  FOR EACH ContinousAE IN adverseEvent.segments:
    // An AE is Treatment-Emergent if any of its continuous periods start on or after Day 1...
    IF ContinousAE.startDate >= treatmentStartDate:
      // ...AND its severity is greater than the pre-treatment severity.
      // (This covers both new events and worsening of pre-existing, resolved events).
      IF severity(ContinousAE.severity) > severity(preTreatmentSeverity):
        // This Adverse Event IS Treatment-Emergent.
        RETURN TRUE

  // 3. If no Continous AE meets the criteria, the event is not Treatment-Emergent.
  RETURN FALSE`;
            const modalHTML = `
                <div class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl p-6 md:p-8 w-11/12 md:w-1/2 lg:w-1/3 relative max-h-[90vh] overflow-y-auto">
                        <button onclick="hideModals()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">TEAE Determination Pseudocode</h2>
                        <pre class="bg-gray-100 p-4 rounded-md text-sm text-gray-800 overflow-x-auto"><code>${pseudocode}</code></pre>
                        <div class="flex justify-end mt-6">
                            <button onclick="hideModals()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Close</button>
                        </div>
                    </div>
                </div>`;
            showModal(modalHTML);
        });

        // --- INITIAL RENDER ---
        document.addEventListener('DOMContentLoaded', renderAll);
    </script>
</body>
</html>
